# OVH 服务器列表获取优化说明

## 优化前的问题

### 后端问题
1. **无缓存机制** - 每次`/api/servers`请求都调用OVH API
2. **高频API调用** - 每个服务器都要单独查询可用性
3. **资源浪费** - OVH API调用耗时长，频繁调用影响性能

### 前端问题
1. **自动定时刷新** - 每30分钟自动触发API请求
2. **认证变化触发** - 每次认证状态变化都触发请求
3. **缓存时间短** - 只缓存30分钟

## 优化方案

### 后端优化

#### 1. 添加服务器列表缓存机制
```python
# 新增全局缓存对象
server_list_cache = {
    "data": [],
    "timestamp": None,
    "cache_duration": 2 * 60 * 60  # 缓存2小时
}
```

#### 2. 修改 `/api/servers` 端点
- 添加缓存检查逻辑
- 支持 `forceRefresh` 参数强制刷新
- 返回缓存信息给前端
- 缓存有效期内直接返回缓存数据

**新增参数：**
- `showApiServers`: 是否有API配置
- `forceRefresh`: 是否强制刷新（绕过缓存）

**返回格式：**
```json
{
  "servers": [...],
  "cacheInfo": {
    "cached": true,
    "timestamp": 1234567890,
    "cacheAge": 300,
    "cacheDuration": 7200
  }
}
```

### 前端优化

#### 1. 移除自动定时刷新
- 删除30分钟自动刷新定时器
- 避免不必要的后台API调用

#### 2. 增加缓存时间
- 从30分钟增加到2小时（与后端保持一致）

#### 3. 优化请求策略
- 保留前端LocalStorage缓存
- 只在以下情况下请求后端：
  - 首次加载
  - 缓存过期
  - 认证状态改变（强制刷新）
  - 用户手动刷新

#### 4. 防止并发请求
- 使用 `isActuallyFetching` 标记避免重复请求
- 缓存有效时直接跳过API调用

## 优化效果

### API调用频率降低
- **优化前**：每30分钟自动刷新 + 每次认证变化 = 高频调用
- **优化后**：2小时缓存 + 手动刷新 = 大幅降低调用频率

### 性能提升
- 后端缓存2小时，避免频繁调用OVH API
- 前端缓存2小时，减少网络请求
- 用户体验更快：大部分情况下直接使用缓存数据

### 资源节约
- 减少OVH API调用次数，降低API配额消耗
- 减少服务器负载
- 减少网络带宽使用

## 使用说明

### 用户操作
- **正常使用**：页面加载时自动使用缓存数据（如果存在且未过期）
- **手动刷新**：可通过前端按钮强制刷新服务器列表
- **配置API后**：配置API凭证后会强制刷新一次获取最新数据

### 开发者选项
如需强制刷新，可在前端调用：
```typescript
fetchServers(true); // forceRefresh = true
```

后端会收到 `forceRefresh=true` 参数，绕过缓存重新从OVH API获取数据。

## 注意事项

1. **缓存时长**：目前设置为2小时，可根据实际需求调整
2. **手动刷新**：如需最新数据，用户需要手动刷新
3. **认证变化**：更改API配置后会自动刷新数据
4. **缓存存储**：
   - 后端：内存缓存（重启后失效）
   - 前端：LocalStorage（持久化）

## 未来优化建议

1. 后端缓存持久化到文件或Redis
2. 添加缓存过期通知机制
3. 支持按数据中心缓存可用性信息
4. 添加缓存管理API端点
