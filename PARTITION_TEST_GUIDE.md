# 分区方案功能测试指南

## 🔧 前置条件

### 1. 重启后端（必须）
```bash
# 停止当前后端 (Ctrl+C)
python backend/app.py
```

## 📋 测试步骤

### 步骤1: 打开重装对话框
1. 选择一台服务器
2. 点击"重装系统"按钮

### 步骤2: 选择系统模板
1. 在"操作系统模板"下拉框中选择一个模板（如 `debian11_64`）
2. **观察界面变化：**

#### ✅ 成功情况（后端正常）
```
选择模板后，你会看到：

1. 出现"正在加载分区方案..."提示（带旋转图标）
   ↓
2. 1-2秒后显示：
   ┌─────────────────────────┐
   │ 分区方案（可选）         │
   │ ┌─────────────────────┐  │
   │ │ default (4 个分区)   │  │
   │ └─────────────────────┘  │
   │ [查看分区详情]           │
   └─────────────────────────┘

3. Toast提示："已加载 X 个分区方案"
```

#### ❌ 失败情况（后端未重启或404）
```
选择模板后，你会看到：

1. 出现"正在加载分区方案..."
   ↓
2. 然后显示错误提示：
   "获取分区方案失败，请重启后端服务器"

3. 分区方案选择器不显示
```

### 步骤3: 查看分区详情
1. 如果分区方案加载成功
2. 点击"查看分区详情"按钮
3. 应该看到：
```
┌─────────────────────────────┐
│ /          - 20480 MB        │
│ ext4 | primary | RAID: 1     │
├─────────────────────────────┤
│ /home      - 40960 MB        │
│ ext4 | primary | RAID: 1     │
├─────────────────────────────┤
│ swap       - 4096 MB         │
│ swap | primary | RAID: N/A   │
└─────────────────────────────┘
```

### 步骤4: 测试重装
1. 选择一个分区方案
2. （可选）输入自定义主机名
3. 点击"确认重装"
4. 确认提示
5. 检查是否成功

## 🐛 故障排查

### 问题1: 没有显示"正在加载..."
**原因**: 前端代码未保存或浏览器未刷新
**解决**: 
- 刷新浏览器 (Ctrl+F5)
- 重新打开重装对话框

### 问题2: 一直显示"正在加载..."
**原因**: 后端请求失败
**解决**:
1. 打开浏览器开发者工具 (F12)
2. 查看Network标签
3. 找到 `partition-schemes` 请求
4. 查看状态码：
   - 404 → 后端未重启
   - 401 → API密钥问题
   - 500 → 后端错误，查看后端日志

### 问题3: 显示"该模板无可用分区方案"
**原因**: 某些模板确实没有自定义分区方案
**解决**: 这是正常的，选择其他模板测试

### 问题4: 显示"获取分区方案失败，请重启后端服务器"
**原因**: 404错误，后端路由未生效
**解决**: 
```bash
# 停止后端 (Ctrl+C)
# 重新启动
python backend/app.py
```

## ✅ 验证功能完整性

完整功能检查清单：
- [ ] 选择模板后显示加载状态
- [ ] 加载成功显示分区方案选择器
- [ ] 可以选择不同的分区方案
- [ ] 点击"查看分区详情"能展开/收起
- [ ] 分区详情显示完整（挂载点、大小、文件系统、RAID）
- [ ] 确认重装时分区方案会传递给后端
- [ ] 后端日志显示"使用自定义分区方案: xxx"

## 🎯 API测试（可选）

直接测试后端API：
```bash
# 替换YOUR_SERVER和YOUR_TEMPLATE
curl "http://localhost:5000/api/server-control/YOUR_SERVER/partition-schemes?templateName=YOUR_TEMPLATE"

# 示例
curl "http://localhost:5000/api/server-control/ns3002233.ip-151-80-20.eu/partition-schemes?templateName=debian11_64"
```

预期响应：
```json
{
  "success": true,
  "schemes": [
    {
      "name": "default",
      "priority": 1,
      "partitions": [
        {
          "mountpoint": "/",
          "filesystem": "ext4",
          "size": 20480,
          "order": 1,
          "raid": "1",
          "type": "primary"
        },
        ...
      ]
    }
  ]
}
```

## 📝 完成标志

如果你看到分区方案选择器正常显示，并能查看详情，说明功能已经正常工作！
